<!DOCTYPE html>
<html>
  <head>
    <title>Getting around</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.0.1/css/ol.css" type="text/css">
    <link rel="stylesheet" href="../css/bootstrap.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.0.1/build/ol.js"></script>
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4.js"></script>
    
    <style type="text/css">
      html, body, .map {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      img.logo {
          height: 120px;
          cursor: pointer;
          cursor: hand;
      }
      img.icon {
          height: 40px;
          cursor: pointer;
          cursor: hand;
        /*
          border-radius: 6px;
          border: 3px solid black;
          background-color: rgba(255, 255, 255, 0.33);
        */
      }
      div.custom-control {
          top: 80px;
          left: .5em;
      }
      div[role="navctrl"] .ol-control button {
          background-color: rgba(0, 136, 52, 0.5);
      }
      div[role="navctrl"].running .ol-control button {
          background-color: rgba(136, 0, 73, 0.5);
      }
    </style>
  </head>
  <body>
    <div id="map" class="map"></div>
    <template id="nav-toggle">
       <div class="ol-selectable ol-control custom-control" >
         <button><span class="glyphicon glyphicon-screenshot"></span></button>
       </div>
    </template>
    <template role="marker" data-config='{"zoomlimits": {"max": 15}, "layout": "bottom-left", "animate": {"zoom": 17}}'>
      <img class="logo" src="./plan/marker_logo_veldenduin.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97834,51.25236], "animate": {"zoom": 19}}'>
      <img class="icon" src="./plan/display-crash.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97854,51.25162], "animate": {"zoom": 19}}'>
      <img class="icon" src="./plan/display-duikers.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97893,51.24996], "animate": {"zoom": 19}}'>
      <img class="icon" src="./plan/display-redder.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97899,51.25083], "animate": {"zoom": 19}}'>
      <img class="icon" src="./plan/display-flitspaal.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97907,51.24939], "animate": {"zoom": 19}}'>
      <img class="icon" src="./plan/display-milling.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97779,51.25141], "animate": {"zoom": 19}}'>
      <img class="icon" src="./plan/display-filmkabinet.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97779,51.25141], "animate": {"zoom": 19}}'>
      <img class="icon" src="./plan/display-verlorenvoorwerp.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97767,51.25184], "animate": {"zoom": 19}}'>
      <img class="icon" src="./plan/display-klaaghaag.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97907,51.25233], "zoomlimits": {"min": 19}}'>
      <img class="icon" src="./plan/mark-toilet.svg" />
    </template>
    <template role="marker" data-config='{"geo": [2.97954,51.24982], "zoomlimits": {"min": 19}}'>
      <img class="icon" src="./plan/mark-toilet.svg" />
    </template>
    <template id="locator" >
      <img class="locator" src="./geolocation_marker.png" />
    </template>
    <script>
      "use strict";
      function isEmpty(a) {
          return (a === null || a === undefined || (a.hasOwnProperty("length") && a.length === 0));
      }   

      function isString(s) {
          return Object.prototype.toString.call(s) === '[object String]';
      }   

      window.app = {};
      var map, view, imageExtent, $markers, center, $navbtn, navctrl, app = window.app, $loc;
      proj4.defs("EPSG:31370", "+proj=lcc +lat_1=51.16666723333333 +lat_2=49.8333339 " +
                 "+lat_0=90 +lon_0=4.367486666666666 +x_0=150000.013 +y_0=5400088.438 " +
                 "ellps=intl +towgs84=106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1 "+
                 "units=m +no_defs");

      imageExtent = [53018,216498,53293,216990];
      view = new ol.View({
          center: ol.proj.transform(ol.extent.getCenter(imageExtent), 'EPSG:31370', 'EPSG:3857'),
          zoom: 17
      });

      function MyGeoLocation(period, fnOnUpdate) {
          if (!navigator.geolocation) {
              console.log("GEOLOCATION NOT SUPPORTED");
          }
          this.period = Number(period);
          this.period = (!isNaN(this.period)) ? this.period : 500;
          this.handle = null;
          this.watchdog = null;
          this.position = null;
          this.heading = null;
          this.speed = null;
          this.lasttime = null;
          this.positions = [];
          this.fnOnUpdate = fnOnUpdate || function () {};
      }
      
      // TODO: grab distance-between function from veldenduin

//          // convert radians to degrees
//          function radToDeg(rad) {
//              return rad * 360 / (Math.PI * 2);
//          }
//          // convert degrees to radians
//          function degToRad(deg) {
//              return deg * Math.PI * 2 / 360;
//          }
//          // modulo for negative values
//          function mod(n) {
//              return ((n % (2 * Math.PI)) + (2 * Math.PI)) % (2 * Math.PI);
//          }
      MyGeoLocation.prototype.update = function(position) {
          this.position = position;
          this.lasttime = Date.now();
          // TODO calculate speed, heading, ... using the last x positions and timings
          /* object structure:
           Geoposition
              coords: Coordinates
                  accuracy: 38
                  altitude:null
                  altitudeAccuracy:null
                  heading:null
                  latitude:51.2523455
                  longitude:2.977261
                  speed:null
          */
          // slice position-array to remove all but last 20
          this.fnOnUpdate({
              "position": this.position.coords,
              "heading": this.position.coords.heading,
              "speed": this.position.coords.speed,
              "ts": this.lasttime
          });
      }
      
      MyGeoLocation.prototype.start = function($btn) {
          var me = this;
          this.stop();
          function onGeoUpdate (position) {
              if (me.watchdog) { // shut the dog
                  clearTimeout(me.watchdog);
                  me.watchdog = null;
              }
              me.update(position);
              me.handle = setTimeout(requestGeoUpdate,  me.period);
          }
          function requestGeoUpdate () {
              navigator.geolocation.getCurrentPosition(onGeoUpdate);
          }
          function waitTimeOut () {
              console.log("no geo location data received") ;
              me.watchdog = null;
              me.stop($btn);
          }
          me.watchdog = setTimeout(waitTimeOut,  5 * me.period); // launch the dog
          me.handle = setTimeout(requestGeoUpdate, 0);
          $btn.addClass("running");
          console.log("geolocator started.");
      }
      
      MyGeoLocation.prototype.stop = function ($btn) {
          if (this.handle !== null) {
              clearTimeout(this.handle);
              this.handle = null;
              $btn.removeClass("running");
              console.log("geolocator stopped.");
          }
      }

      MyGeoLocation.prototype.toggle = function ($btn) {
          if (this.handle === null) {
              this.start($btn);
          } else {
              this.stop($btn);
          }
      }

      app.NavToggle = function (opt_options) {
          var options = opt_options || {},
              $navbtn, $elm,
              me = this, 
              positions = new ol.geom.LineString([], ('XYZM')),
              geolocation,
              deltaMean = 500,
              previousM = 0,
              $loc, locator;
        
          function drawPosition (geoData) {
              console.log("update geoData ", geoData ); 
              addPosition(geoData.position, geoData.heading, geoData.ts, geoData.speed);
          }
        
          function doToggle() {
              if( locator === undefined ) {
                  $loc = $($('template#locator').html()),
                  locator = new ol.Overlay({
                      positioning: 'center-center',
                      element: $loc.get(0),
                      stopEvent: false
                  });
                  map.addOverlay(locator);
                
                  // Listen to position changes
                  geolocation = new MyGeoLocation(500, drawPosition)
              }
              geolocation.toggle($elm);
          }
        

          function addPosition(position, heading, m, speed) {
              // TODO rotate view 
//              view.setCenter(getCenterWithHeading(c, -c[2], view.getResolution()));
//              view.setRotation(-c[2]);
              var c = ol.proj.transform([position.longitude, position.latitude], 'EPSG:4326', 'EPSG:3857')
              //view.setCenter(c);
              locator.setPosition(c);
            
              if (heading && speed) {
                  $loc.attr('src','./geolocation_marker_heading.png');
              } else {
                  $loc.attr('src','./geolocation_marker.png');
              }
          }

          function navtoggle() {
              console.log("ze control waz poesjt");
              doToggle();
          }
          $navbtn = $($('template#nav-toggle').html()).click(navtoggle);
          $elm = $('<div role="navctrl" class=""></div>').append($navbtn);


          ol.control.Control.call(this, {
              element: $elm.get(0),
              target: options.target
          });
          console.log("navtoggle constructor", $elm.get(0));
      }
      ol.inherits(app.NavToggle, ol.control.Control);


      map = new ol.Map({
        controls: ol.control.defaults({
            attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
                collapsible: false
            })
        }).extend([
            new app.NavToggle()
        ]),
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          new ol.layer.Image({
            source: new ol.source.ImageStatic({
              url: './plan/grondplan.svg',
              crossOrigin: '',
              projection: 'EPSG:31370',
              imageExtent: imageExtent
            })
          })
        ],
        target: 'map',
        view: view
      });

      center = ol.proj.transform(view.getCenter(), 'EPSG:3857', 'EPSG:4326');
      $markers = $('template[role="marker"]');
      $markers.each(function() {
          var $mt = $(this),
              config = $mt.data('config') || {},
              geo = config.geo || center,
              animate = config.animate,
              zoomlims = config.zoomlimits || {"min": 16},
              layout = config.layout || 'center-left',
              $el = $($mt.html()),
              ov = new ol.Overlay({
                  position: ol.proj.fromLonLat(geo),
                  positioning: layout,
                  element: $el.get(0),
                  stopEvent: false
              });
              $mt.data('adapt-to-zoom', function (zoom) {
                  if (isEmpty(zoom)) {return; }
                  if (!isEmpty(zoomlims.min)) {
                      if (zoom < zoomlims.min) {  $el.hide(); }
                      else { $el.show(); }
                  } 
                  if (!isEmpty(zoomlims.max)) { 
                      if (zoom > zoomlims.max) {  $el.hide(); }
                      else { $el.show(); }
                  }
              });
              map.addOverlay(ov);
              $el.click(function() {
                  console.log("click on " + $el.get(0));
              });
        
              if (!isEmpty(config.animate)) {
                  animate.center = ol.proj.fromLonLat(geo);
                  animate.duration = animate.duration || 5000;
                  $el.click(function () { view.animate(animate); });
              }
      });
      function updateVisibleMarkers(event) {
          var zoom = view.getZoom();
          
          if (isEmpty(event) || event.key === "resolution") {
              $markers.each(function() { $(this).data('adapt-to-zoom')(zoom)});
          }
      }
      view.on("propertychange", updateVisibleMarkers);
      updateVisibleMarkers();
      
    </script>
  </body>
</html>